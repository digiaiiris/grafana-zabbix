define(["react","lodash","moment","@grafana/runtime","jquery","@grafana/ui","app/core/utils/datemath","app/plugins/sdk","app/core/utils/kbn","angular","app/core/core_module","app/core/table_model","emotion","app/core/config"],(function(e,t,n,r,a,i,o,u,s,c,l,f,p,m){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=40)}([function(t,n){t.exports=e},function(e,n){e.exports=t},,function(e,t,n){"use strict";n.d(t,"r",(function(){return f})),n.d(t,"e",(function(){return p})),n.d(t,"f",(function(){return m})),n.d(t,"c",(function(){return d})),n.d(t,"p",(function(){return g})),n.d(t,"m",(function(){return v})),n.d(t,"j",(function(){return b})),n.d(t,"k",(function(){return x})),n.d(t,"i",(function(){return T})),n.d(t,"a",(function(){return k})),n.d(t,"d",(function(){return A})),n.d(t,"l",(function(){return S})),n.d(t,"n",(function(){return w})),n.d(t,"g",(function(){return C})),n.d(t,"q",(function(){return D})),n.d(t,"o",(function(){return E})),n.d(t,"b",(function(){return O})),n.d(t,"h",(function(){return I}));var r=n(1),a=n.n(r),i=n(8),o=n.n(i),u=n(17),s=n.n(u),c=n(5),l=n(7),f=/\$(\w+)|\[\[([\s\S]+?)(?::(\w+))?\]\]|\${(\w+)(?:\.([^:^\}]+))?(?::(\w+))?}/g;function p(e,t){for(var n,r,i,o,u,s=t.substring(t.indexOf("[")+1,t.lastIndexOf("]")),c=(n=s,r=[],i=!1,o=!1,u="",a.a.forEach(n,(function(e){'"'===e&&o?u+=e:'"'===e&&i?i=!1:'"'!==e||i?"["!==e||i?"]"!==e||i?","!==e||i||o?u+=e:(r.push(u),u=""):o=!1:o=!0:i=!0})),r.push(u),r),l=c.length;l>=1;l--)e=e.replace("$"+l,c[l-1]);return e}function m(e){return a.a.forEach(e,(function(e){return e.item=e.name,e.name=p(e.item,e.key_),e})),e}var h=/{\$[A-Z0-9_\.]+}/g;function d(e){return h.test(e)}function g(e,t){var n=e.name,r=n.match(h);return a.a.forEach(r,(function(r){var i=a.a.filter(t,(function(t){return!t.hostid||t.hostid===e.hostid})),o=a.a.find(i,{macro:r});if(o&&o.value){var u=o.value,s=new RegExp(function(e){return e=e.replace(/\$/,"\\$")}(r));n=n.replace(s,u)}})),n}function v(e){var t,n=[];a.a.each(function(e){var t;if(function(e){return/^\{.+\}$/.test(e)}(e)){var n=e.match(/\{[^\{\}]*\}|\{\/.*\/\}/g);t=a.a.map(n,(function(e){return a.a.trim(e,"{}")}))}else t=e.split(".");return t}(e),(function(e){"*"===e&&(e="/.*/"),n.push(e)}));var r=a.a.zipObject(["group","host","app","item"],n);switch(4===n.length&&"/.*/"===r.app&&(r.app=""),n.length){case 1:t=l.a.Group;break;case 2:t=l.a.Host;break;case 3:t=l.a.Application;break;case 4:t=l.a.Item}return{queryType:t,group:r.group||"",host:r.host||"",application:r.app||"",item:r.item||""}}var y=/^\/(.*)\/([gmi]*)$/m;function b(e){return y.test(e)}function x(e,t){if(/^\$\w+/.test(e)){var n=a.a.map(t,(function(e){return"$"+e.name}));return a.a.includes(n,e)}return!1}function T(e){var t=e.to.diff(e.from),n=Math.round(t/1e3),r=s.a.secondsToHms(t/1e3);return{__range_ms:{text:t,value:t},__range_s:{text:n,value:n},__range:{text:r,value:r},__range_series:{text:c.h,value:c.h}}}function k(e){var t=e.match(y),n=t[1],r=""!==t[2]?t[2]:void 0;return new RegExp(n,r)}function A(e){return e.replace(/[\\^$*+?.()|[\]{}\/]/g,"\\$&")}function S(e){var t=/(^[\d]+)(y|M|w|d|h|m|s)/g.exec(e);return o.a.duration(Number(t[1]),t[2]).valueOf()}function w(e){var t=/^([\+\-]*)([\d]+)(y|M|w|d|h|m|s)/g.exec(e);return"+"===t[1]?0-o.a.duration(Number(t[2]),t[3]).valueOf():o.a.duration(Number(t[2]),t[3]).valueOf()}function C(e){if(e.length){var t="<br><br>Acknowledges:<br><table><tr><td><b>Time</b></td><td><b>User</b></td><td><b>Comments</b></td></tr>";return a.a.each(a.a.map(e,(function(e){return"<tr><td><i>"+o.a.unix(e.clock).format("DD MMM YYYY HH:mm:ss")+"</i></td><td>"+e.alias+" ("+e.name+" "+e.surname+")</td><td>"+e.message+"</td></tr>"})),(function(e){t=t.concat(e)})),t=t.concat("</table>")}return""}function D(e){return function(t){for(var n=0;n<e.length;n++)t=e[n].call(this,t);return t}}var P=/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:-([0-9A-Za-z\.]+))?/;function E(e){var t=P.exec(e);return t?{major:Number(t[1]),minor:Number(t[2]||0),patch:Number(t[3]||0),meta:t[4]}:null}function O(e){return e.replace(/\s+/g," ").trim()}function I(e,t){if(void 0===t&&(t=0),0===e.length)return 1;var n=e[0];return a.a.isArray(n)?I(n,t+1):t+1}a.a.includes||(a.a.includes=a.a.contains)},,function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"e",(function(){return a})),n.d(t,"d",(function(){return i})),n.d(t,"f",(function(){return o})),n.d(t,"c",(function(){return u})),n.d(t,"g",(function(){return s})),n.d(t,"i",(function(){return c})),n.d(t,"k",(function(){return l})),n.d(t,"j",(function(){return f})),n.d(t,"l",(function(){return p})),n.d(t,"p",(function(){return m})),n.d(t,"n",(function(){return h})),n.d(t,"o",(function(){return d})),n.d(t,"m",(function(){return g})),n.d(t,"b",(function(){return v})),n.d(t,"h",(function(){return y}));var r=1,a=0,i=1,o=2,u=3,s=4,c=2,l=[0,1],f=[0,1],p=1,m=0,h=2,d=4,g=[{val:0,text:"Not classified"},{val:1,text:"Information"},{val:2,text:"Warning"},{val:3,text:"Average"},{val:4,text:"High"},{val:5,text:"Disaster"}],v=3600,y="range_series"},,function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e.Group="group",e.Host="host",e.Application="application",e.Item="item"}(r||(r={}))},function(e,t){e.exports=n},,function(e,t){e.exports=r},function(e,t){e.exports=a},function(e,t){e.exports=i},function(e,t){e.exports=o},function(e,t){e.exports=u},,,function(e,t){e.exports=s},function(e,t){e.exports=c},,,function(e,t){e.exports=l},function(e,t){e.exports=f},function(e,t){e.exports=p},,function(e,t){e.exports=m},,,,,,,,,,,,,,,function(e,t,n){"use strict";nn.$inject=["$compile","templateSrv"],n.r(t);var r=n(14),a=n(1),i=n.n(a),o=n(25),u=n.n(o),s=n(13),c=n(3);function l(e){return e.resultFormat=e.resultFormat||"time_series",function(e){return(!e.mode||0===e.mode||2===e.mode)&&!(!(e.hostFilter||e.itemFilter||e.downsampleFunction||e.host&&e.host.host)||void 0!==e.item.filter||void 0!==e.host.filter)}(e=function(e){e.group&&Array.isArray(e.group)&&(e.group={filter:""});return e}(e))?function(e){return e.group.filter="*"===e.group.name?"/.*/":e.group.name,e.host.filter="*"===e.host.name?f(e.hostFilter):e.host.name,e.application.filter="*"===e.application.name?"":e.application.name,e.item.filter="All"===e.item.name?f(e.itemFilter):e.item.name,e}(e):(function(e){if(e.functions)for(var t=0,n=e.functions;t<n.length;t++){var r=n[t];r.def&&"percentil"===r.def.name&&(r.def.name="percentile")}}(e),e)}function f(e){return e?"/"+e+"/":"/.*/"}var p=2;function m(e){if(e||(e={}),!function(e){if(e.dbConnection&&!i.a.isEmpty(e.dbConnection))return!0;if(e.schema&&e.schema!==p)return!0;return!1}(e))return e;var t=e.schema||1;if(e.schema=p,t<2){var n=e.dbConnection||{};e.dbConnectionEnable=n.enable||!1,e.dbConnectionDatasourceId=n.datasourceId||null,delete e.dbConnection}return e}var h=n(11),d=n.n(h);function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var v=[],y={Transform:[],Aggregate:[],Filter:[],Trends:[],Time:[],Alias:[],Special:[]};function b(e){e.params=e.params||[],e.defaultParams=e.defaultParams||[],e.category&&y[e.category].push(e),v[e.name]=e,v[e.shortName||e.name]=e}b({name:"groupBy",category:"Transform",params:[{name:"interval",type:"string"},{name:"function",type:"string",options:["avg","min","max","sum","count","median"]}],defaultParams:["1m","avg"]}),b({name:"scale",category:"Transform",params:[{name:"factor",type:"float",options:[100,.01,10,-1]}],defaultParams:[100]}),b({name:"offset",category:"Transform",params:[{name:"delta",type:"float",options:[-100,100]}],defaultParams:[100]}),b({name:"delta",category:"Transform",params:[],defaultParams:[]}),b({name:"rate",category:"Transform",params:[],defaultParams:[]}),b({name:"movingAverage",category:"Transform",params:[{name:"factor",type:"int",options:[6,10,60,100,600]}],defaultParams:[10]}),b({name:"exponentialMovingAverage",category:"Transform",params:[{name:"smoothing",type:"float",options:[6,10,60,100,600]}],defaultParams:[.2]}),b({name:"percentile",category:"Transform",params:[{name:"interval",type:"string"},{name:"percent",type:"float",options:[25,50,75,90,95,99,99.9]}],defaultParams:["1m",95]}),b({name:"removeAboveValue",category:"Transform",params:[{name:"number",type:"float"}],defaultParams:[0]}),b({name:"removeBelowValue",category:"Transform",params:[{name:"number",type:"float"}],defaultParams:[0]}),b({name:"transformNull",category:"Transform",params:[{name:"number",type:"float"}],defaultParams:[0]}),b({name:"sumSeries",category:"Aggregate",params:[],defaultParams:[]}),b({name:"median",category:"Aggregate",params:[{name:"interval",type:"string"}],defaultParams:["1m"]}),b({name:"average",category:"Aggregate",params:[{name:"interval",type:"string"}],defaultParams:["1m"]}),b({name:"percentileAgg",category:"Aggregate",params:[{name:"interval",type:"string"},{name:"percent",type:"float",options:[25,50,75,90,95,99,99.9]}],defaultParams:["1m",95]}),b({name:"min",category:"Aggregate",params:[{name:"interval",type:"string"}],defaultParams:["1m"]}),b({name:"max",category:"Aggregate",params:[{name:"interval",type:"string"}],defaultParams:["1m"]}),b({name:"sum",category:"Aggregate",params:[{name:"interval",type:"string"}],defaultParams:["1m"]}),b({name:"count",category:"Aggregate",params:[{name:"interval",type:"string"}],defaultParams:["1m"]}),b({name:"aggregateBy",category:"Aggregate",params:[{name:"interval",type:"string"},{name:"function",type:"string",options:["avg","min","max","sum","count","median"]}],defaultParams:["1m","avg"]}),b({name:"top",category:"Filter",params:[{name:"number",type:"int"},{name:"value",type:"string",options:["avg","min","max","sum","count","median"]}],defaultParams:[5,"avg"]}),b({name:"bottom",category:"Filter",params:[{name:"number",type:"int"},{name:"value",type:"string",options:["avg","min","max","sum","count","median"]}],defaultParams:[5,"avg"]}),b({name:"sortSeries",category:"Filter",params:[{name:"direction",type:"string",options:["asc","desc"]}],defaultParams:["asc"]}),b({name:"trendValue",category:"Trends",params:[{name:"type",type:"string",options:["avg","min","max","sum","count"]}],defaultParams:["avg"]}),b({name:"timeShift",category:"Time",params:[{name:"interval",type:"string",options:["24h","7d","1M","+24h","-24h"]}],defaultParams:["24h"]}),b({name:"setAlias",category:"Alias",params:[{name:"alias",type:"string"}],defaultParams:[]}),b({name:"setAliasByRegex",category:"Alias",params:[{name:"aliasByRegex",type:"string"}],defaultParams:[]}),b({name:"replaceAlias",category:"Alias",params:[{name:"regexp",type:"string"},{name:"newAlias",type:"string"}],defaultParams:["/(.*)/","$1"]}),b({name:"consolidateBy",category:"Special",params:[{name:"type",type:"string",options:["avg","min","max","sum","count"]}],defaultParams:["avg"]}),i.a.each(y,(function(e,t){y[t]=i.a.sortBy(e,"name")}));var x=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.def=t,n?this.params=n:(this.params=[],this.params=t.defaultParams.slice(0)),this.updateText()}var t,n,r;return t=e,(n=[{key:"bindFunction",value:function(e){var t=e[this.def.name];if(t){for(var n,r=t,a=0;a<this.params.length;a++)n=this.params[a],"int"!==this.def.params[a].type&&"float"!==this.def.params[a].type||(n=Number(n)),r=i.a.partial(r,n);return r}throw{message:"Method not found "+this.def.name}}},{key:"render",value:function(e){var t=this.def.name+"(",n=i.a.map(this.params,(function(e,t){var n=this.def.params[t].type;return"int"===n||"float"===n||"value_or_series"===n||"boolean"===n?e:"int_or_interval"===n&&d.a.isNumeric(e)?e:"'"+e+"'"}),this);return e&&n.unshift(e),t+n.join(", ")+")"}},{key:"_hasMultipleParamsInString",value:function(e,t){return-1!==e.indexOf(",")&&this.def.params[t+1]&&this.def.params[t+1].optional}},{key:"updateParam",value:function(e,t){this._hasMultipleParamsInString(e,t)?i.a.each(e.split(","),(function(e,t){this.updateParam(e.trim(),t)}),this):(""===e&&this.def.params[t].optional?this.params.splice(t,1):this.params[t]=e,this.updateText())}},{key:"updateText",value:function(){if(0!==this.params.length){var e=this.def.name+"(";e+=this.params.join(", "),e+=")",this.text=e}else this.text=this.def.name+"()"}}])&&g(t.prototype,n),r&&g(t,r),e}();function T(e,t){if(i.a.isString(e)){if(!v[e])throw{message:"Method not found "+name};e=v[e]}return new x(e,t)}function k(){return y}var A=n(5),S=0,w=1;function C(e,t,n){if(0===e.length)return[];if(t===A.h)return D(e,n);for(var r,a,i=c.l(t),o=[],u=[],s=e.length?E(e[0][w],i):0,l=s,f=0;f<e.length;f++)if((l=E((a=e[f])[w],i))===s)u.push(a[S]);else if(l>s){for(r=n(u),o.push([r,s]),s+=i;s<l;)o.push([null,s]),s+=i;u=[a[S]]}return r=n(u),o.push([r,s]),o}function D(e,t){for(var n,r=[],a=e[0][w],i=e[e.length-1][w],o=0;o<e.length;o++)n=e[o],r.push(n[S]);var u=t(r);return[[u,a],[u,i]]}function P(e){for(var t=null,n=0;n<e.length;n++)null!==e[n]&&(t+=e[n]);return t}function E(e,t){return Math.floor(e/t)*t}function O(e){return i.a.sortBy(e,(function(e){return e[1]}))}function I(e){for(var t,n,r=e.length-1;r>=0;r--)e[r][0]||(t=M(e,r),n=j(e,r),t||(t=n),n||(n=t),e[r][0]=_(e[r][1],t,n));return e}function _(e,t,n){return t[1]===n[1]?(t[0]+n[0])/2:t[0]+(n[0]-t[0])/(n[1]-t[1])*(e-t[1])}function j(e,t){for(var n=t;n<e.length;n++)if(null!==e[n][0])return e[n];return null}function M(e,t){for(var n=t;n>0;n--)if(null!==e[n][0])return e[n];return null}var q={downsample:function(e,t,n,r){for(var a=[],o={from:1e3*t-n,to:1e3*t},u=0,s=0,c=0,l=[],f=e.length-1;f>=0;f-=1)o.from<e[f][1]&&e[f][1]<=o.to?(u+=e[f][0],s++,l.push(e[f][0])):(c=s?u/s:0,"max"===r?a.push([i.a.max(l),o.to]):"min"===r?a.push([i.a.min(l),o.to]):a.push([c,o.to]),o.to=o.from,o.from-=n,u=0,s=0,l=[],f++);return a.reverse()},groupBy:function(e,t,n){var r=c.l(t),a=i.a.groupBy(e,(function(e){return Math.floor(e[1]/r)*r})),o=i.a.mapValues(a,(function(e){var t=i.a.map(e,(function(e){return e[0]}));return n(t)}));return O(i.a.map(o,(function(e,t){return[Number(e),Number(t)]})))},groupBy_perf:C,groupByRange:D,sumSeries:function(e){var t=i.a.uniq(i.a.map(i.a.flatten(e,!0),(function(e){return e[1]})));t=i.a.sortBy(t);var n=i.a.map(e,(function(e){e=function(e,t){for(var n,r=[],a=[],o=0;o<t.length;o++)t[o]<e[0][w]?(n=[0,t[o]],r.push(n)):t[o]>e[e.length-1][w]&&(n=[0,t[o]],a.push(n));return i.a.concat(i.a.concat(r,e),a)}(e,t);var n=i.a.map(e,(function(e){return e[1]})),r=i.a.map(i.a.difference(t,n),(function(e){return[null,e]}));return O(e.concat(r))}));i.a.each(n,I);for(var r,a=[],o=t.length-1;o>=0;o--){r=0;for(var u=n.length-1;u>=0;u--)r+=n[u][o][0];a.push([r,t[o]])}return O(a)},scale:function(e,t){return i.a.map(e,(function(e){return[e[0]*t,e[1]]}))},offset:function(e,t){for(var n=0;n<e.length;n++)e[n]=[e[n][S]+t,e[n][w]];return e},scale_perf:function(e,t){for(var n=0;n<e.length;n++)e[n]=[e[n][S]*t,e[n][w]];return e},delta:function(e){for(var t,n=[],r=1;r<e.length;r++)t=e[r][0]-e[r-1][0],n.push([t,e[r][1]]);return n},rate:function(e){for(var t,n,r=[],a=0,i=0,o=1;o<e.length;o++)t=e[o],n=e[o-1],i=(t[w]-n[w])/1e3,t[S]>=n[S]&&(a=(t[S]-n[S])/i),r.push([a,t[w]]);return r},simpleMovingAverage:function(e,t){for(var n,r=[],a=null,i=0,o=t;o>0;o--)null!==e[t-o][S]&&(a+=e[t-o][S],i++);i>0?a/=i:a=null,r.push([a,e[t-1][w]]);for(var u=t;u<e.length;u++)null!==e[u][S]&&(a=((n=a*i)+e[u][S])/(i+1),i++),null!==e[u-t][S]&&(n=a*i,i>1?(a=(n-e[u-t][S])/(i-1),i--):(a=null,i=0)),r.push([a,e[u][w]]);return r},expMovingAverage:function(e,t){var n,r,a=[e[0]],i=e[0][S];if(t>1){r=2/(t+1);for(var o=null,u=0,s=t;s>0;s--)null!==e[t-s][S]&&(o+=e[t-s][S],u++);u>0&&(a=[[o/=u,e[0][w]]],i=o,t=1)}else r=t,t=1;for(var c=t;c<e.length;c++)null!==e[c][S]?(i=n=r*e[c][S]+(1-r)*i,a.push([n,e[c][w]])):a.push([null,e[c][w]]);return a},SUM:P,COUNT:function(e){return e.length},AVERAGE:function(e){var t=function(e){for(var t=[],n=0;n<e.length;n++)null!==e[n]&&t.push(e[n]);return t}(e);return 0===t.length?null:P(t)/t.length},MIN:function(e){return i.a.min(e)},MAX:function(e){return i.a.max(e)},MEDIAN:function(e){var t=i.a.sortBy(e);return t[Math.floor(t.length/2)]},PERCENTILE:function(e,t){var n=i.a.sortBy(t);return n[Math.floor(n.length*e/100)]},sortByTime:O,flattenDatapoints:function(e){return c.h(e)<=2?e:i.a.flatten(e)}},B=q.SUM,R=q.COUNT,N=q.AVERAGE,F=q.MIN,z=q.MAX,V=q.MEDIAN,H=q.PERCENTILE,L=q.downsample,Q=q.sumSeries;function G(e,t,n,r){var a=W[n],o=i.a.sortBy(r,(function(e){var t=i.a.map(e.datapoints,(function(e){return e[0]}));return a(t)}));return"bottom"===e?o.slice(0,t):o.slice(-t)}function U(e,t,n){var r=q.flattenDatapoints(n);return C(q.sortByTime(r),t,e)}var $={groupBy:function(e,t,n){return C(n,e,W[t])},scale:function(e,t){return q.scale_perf(t,e)},offset:function(e,t){return q.offset(t,e)},delta:q.delta,rate:q.rate,movingAverage:function(e,t){return q.simpleMovingAverage(t,e)},exponentialMovingAverage:function(e,t){return q.expMovingAverage(t,e)},percentile:function(e,t,n){return C(n,e,i.a.partial(H,t))},transformNull:function(e,t){return i.a.map(t,(function(t){return[null!==t[0]?t[0]:e,t[1]]}))},aggregateBy:function(e,t,n){var r=q.flattenDatapoints(n);return C(q.sortByTime(r),e,W[t])},percentileAgg:function(e,t,n){var r=q.flattenDatapoints(n);return C(q.sortByTime(r),e,i.a.partial(H,t))},average:i.a.partial(U,N),min:i.a.partial(U,F),max:i.a.partial(U,z),median:i.a.partial(U,V),sum:i.a.partial(U,B),count:i.a.partial(U,R),sumSeries:Q,removeAboveValue:function(e,t){return i.a.map(t,(function(t){return[t[0]>e?null:t[0],t[1]]}))},removeBelowValue:function(e,t){return i.a.map(t,(function(t){return[t[0]<e?null:t[0],t[1]]}))},top:i.a.partial(G,"top"),bottom:i.a.partial(G,"bottom"),sortSeries:function(e,t){return i.a.orderBy(t,[function(e){return e.target.toLowerCase()}],e)},timeShift:function(e,t){var n=c.n(e)/1e3;return i.a.map(t,(function(e){return e-n}))},setAlias:function(e,t){return t.target=e,t},setAliasByRegex:function(e,t){var n;return t.target=(n=t.target,new RegExp(e).exec(n)[0]),t},replaceAlias:function(e,t,n){var r;r=c.j(e)?c.a(e):e;var a=n.target.replace(r,t);return n.target=a,n}},W={avg:N,min:F,max:z,median:V,sum:B,count:R},Y={downsampleSeries:L,groupBy:function(e,t,n){return C(n,e,t)},AVERAGE:N,MIN:F,MAX:z,MEDIAN:V,SUM:B,COUNT:R,unShiftTimeSeries:function(e,t){var n=c.n(e);return i.a.map(t,(function(e){return[e[0],e[1]+n]}))},get aggregationFunctions(){return W},get metricFunctions(){return $}},Z=n(22),X=n.n(Z);function K(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function J(e,t,n,r){var a=i.a.groupBy(e,"itemid"),o=i.a.uniqBy(i.a.flatten(i.a.map(t,"hosts")),"hostid");return i.a.map(a,(function(e,a){var u=i.a.find(t,{itemid:a}),s=u.name;i.a.keys(o).length>1&&n&&(s=i.a.find(o,{hostid:u.hostid}).name+": "+s);return{target:s,datapoints:i.a.map(e,r)}}))}function ee(e,t){var n=t.value;return e.textFilter&&(n=te(t.value,e.textFilter,e.useCaptureGroups)),[n,1e3*t.clock+Math.round(t.ns/1e6)]}function te(e,t,n){var r=new RegExp(t).exec(e);return r&&(r=n?r[1]:r[0]),r}function ne(e){return[Number(e.value),1e3*e.clock+Math.round(e.ns/1e6)]}function re(e,t){var n;switch(e){case"min":n=t.value_min;break;case"max":n=t.value_max;break;case"avg":n=t.value_avg;break;case"sum":n=t.value_sum;break;case"count":n=t.value_count;break;default:n=t.value_avg}return[Number(n),1e3*t.clock]}var ae={handleHistory:function(e,t){return J(e,t,!(arguments.length>2&&void 0!==arguments[2])||arguments[2],ne)},convertHistory:J,handleTrends:function(e,t,n){return J(e,t,!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i.a.partial(re,n))},handleText:function(e,t,n){return J(e,t,!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i.a.partial(ee,n))},handleHistoryAsTable:function(e,t,n){var r=new X.a;r.addColumn({text:"Host"}),r.addColumn({text:"Item"}),r.addColumn({text:"Key"}),r.addColumn({text:"Last value"});var a=i.a.groupBy(e,"itemid");return i.a.each(t,(function(e){var t=a[e.itemid]||[],o=i.a.last(t),u=o?o.value:null;if(!n.options.skipEmptyValues||u&&""!==u){n.textFilter&&(u=te(u,n.textFilter,n.useCaptureGroups));var s=i.a.first(e.hosts);s=s?s.name:"",r.rows.push([s,e.name,e.key_,u])}})),r},handleSLAResponse:function(e,t,n){var r=n[e.serviceid].sla;if("status"===t.property){var a=parseInt(n[e.serviceid].status);return{target:e.name+" "+t.name,datapoints:[[a,1e3*r[0].to]]}}var i,o=[];for(i=0;i<r.length;i++)0===i&&o.push([r[i][t.property],1e3*r[i].from]),o.push([r[i][t.property],1e3*r[i].to]);return{target:e.name+" "+t.name,datapoints:o}},handleTriggersResponse:function(e,t,n){if(i.a.isArray(e)){var r=function(e){var t=i.a.uniq(i.a.flattenDeep(i.a.map(e,(function(e){return i.a.map(e.groups,"name")})))),n={};return i.a.each(t,(function(e){n[e]={0:0,1:0,2:0,3:0,4:0,5:0}})),i.a.each(e,(function(e){i.a.each(e.groups,(function(t){n[t.name][e.priority]++}))})),n}(e),a=i.a.map(t,"name"),o=new X.a;return o.addColumn({text:"Host group"}),i.a.each(i.a.orderBy(A.m,["val"],["desc"]),(function(e){o.addColumn({text:e.text})})),i.a.each(r,(function(e,t){if(i.a.includes(a,t)){var n=i.a.map(i.a.orderBy(i.a.toPairs(e),(function(e){return e[0]}),["desc"]),(function(e){return e[1]}));n=i.a.concat.apply(i.a,[[t]].concat(K(n))),o.rows.push(n)}})),o}var u=null;try{u=Number(e)}catch(e){console.log("Error when handling triggers count: ",e)}return{target:"triggers count",datapoints:[[u,1e3*n[1]]]}},sortTimeseries:function(e){return i.a.forEach(e,(function(e){e.datapoints=i.a.sortBy(e.datapoints,(function(e){return e[A.a]}))})),e}};function ie(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}i.a.uniqBy||(i.a.uniqBy=i.a.uniq);var oe=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cacheEnabled=t.enabled,this.ttl=t.ttl||6e5,this.cache={},this.promises={}}var t,n,r;return t=e,(n=[{key:"cacheRequest",value:function(e,t,n){return function(e,t,n,r){return function(){r.cache[t]||(r.cache[t]={});var a=r.cache[t],i=ue(arguments);return r.cacheEnabled&&!r._isExpired(a[i])?Promise.resolve(a[i].value):e.apply(n,arguments).then((function(e){return a[i]={value:e,timestamp:Date.now()},e}))}}(e,t,n,this)}},{key:"proxyfy",value:function(e,t,n){return this.promises[t]||(this.promises[t]={}),function(e,t,n){return function(){var r=ue(arguments);return t[r]||(t[r]=Promise.resolve(e.apply(n,arguments).then((function(e){return t[r]=null,e})))),t[r]}}(e,this.promises[t],n)}},{key:"proxyfyWithCache",value:function(e,t,n){var r=this.proxyfy(e,t,n);return this.cacheRequest(r,t,n)}},{key:"_isExpired",value:function(e){if(e){var t=Date.now()-e.timestamp;return!(e.timestamp&&t<this.ttl)}return!0}}])&&ie(t.prototype,n),r&&ie(t,r),e}();function ue(e){return JSON.stringify(e).getHash()}String.prototype.getHash=function(){var e,t,n=0;if(0!==this.length)for(e=0,t=this.length;e<t;e++)n=(n<<5)-n+this.charCodeAt(e),n|=0;return n};var se=n(10);function ce(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function le(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function fe(e,t,n){return t&&le(e.prototype,t),n&&le(e,n),e}var pe=1e4,me={0:"history",1:"history_str",2:"history_log",3:"history_uint",4:"history_text"},he={0:"trends",3:"trends_uint"},de={avg:"value_avg",min:"value_min",max:"value_max",sum:"num*value_avg"},ge=function(){function e(t){ce(this,e),this.datasourceId=t.datasourceId,this.datasourceName=t.datasourceName,this.datasourceTypeId=null,this.datasourceTypeName=null}return fe(e,[{key:"loadDBDataSource",value:function(){var t=this;return e.loadDatasource(this.datasourceId,this.datasourceName).then((function(e){return t.datasourceTypeId=e.meta.id,t.datasourceTypeName=e.meta.name,t.datasourceName||(t.datasourceName=e.name),t.datasourceId||(t.datasourceId=e.id),e}))}},{key:"testDataSource",value:function(){throw new ve("testDataSource()")}},{key:"getHistory",value:function(){throw new ve("getHistory()")}},{key:"getTrends",value:function(){throw new ve("getTrends()")}},{key:"handleGrafanaTSResponse",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return ye(e,t,n)}}],[{key:"loadDatasource",value:function(e,t){if(!t&&void 0!==e){var n=i.a.find(Object(se.getDataSourceSrv)().getAll(),{id:e});if(!n)return Promise.reject("Data Source with ID ".concat(e," not found"));t=n.name}return t?Object(se.getDataSourceSrv)().loadDatasource(t):Promise.reject("Data Source name should be specified")}}]),e}(),ve=function(){function e(t){ce(this,e),this.code=null,this.name="ZabbixNotImplemented",this.message="Zabbix DB Connector Error: method ".concat(t||""," should be implemented in subclass of DBConnector")}return fe(e,[{key:"toString",value:function(){return this.message}}]),e}();function ye(e,t,n){var r=i.a.uniqBy(i.a.flatten(i.a.map(t,"hosts")),"hostid"),a=i.a.map(i.a.compact(e),(function(e){var a=e.name,o=i.a.find(t,{itemid:a}),u=o.name;i.a.keys(r).length>1&&n&&(u=i.a.find(r,{hostid:o.hostid}).name+": "+u);return{target:u,datapoints:i.a.cloneDeep(e.points)}}));return i.a.sortBy(a,"target")}var be={DBConnector:ge,DEFAULT_QUERY_LIMIT:pe,HISTORY_TO_TABLE_MAP:me,TREND_TO_TABLE_MAP:he,consolidateByFunc:{avg:"AVG",min:"MIN",max:"MAX",sum:"SUM",count:"COUNT"},consolidateByTrendColumns:de},xe=n(17),Te=n.n(xe);function ke(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ae(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Se(e,t,n){return t&&Ae(e.prototype,t),n&&Ae(e,n),e}var we=function(){function e(){ke(this,e)}return Se(e,[{key:"request",value:function(e,t,n,r,a){var i={jsonrpc:"2.0",method:t,params:n,id:1};if(""===a)return Promise.reject(new Ce({data:"Not authorised."}));a&&(i.auth=a);var o={method:"POST",url:e,data:i,headers:{"Content-Type":"application/json"}};return(r.basicAuth||r.withCredentials)&&(o.withCredentials=!0),r.basicAuth&&(o.headers.Authorization=r.basicAuth),this.datasourceRequest(o)}},{key:"datasourceRequest",value:function(e){return Object(se.getBackendSrv)().datasourceRequest(e).then((function(e){return e.data?e.data.error?Promise.reject(new Ce(e.data.error)):e.data.result:Promise.reject(new Ce({data:"General Error, no data"}))}))}},{key:"login",value:function(e,t,n,r){var a={user:t,password:n};return this.request(e,"user.login",a,r,null)}},{key:"getVersion",value:function(e,t){return this.request(e,"apiinfo.version",[],t)}}]),e}(),Ce=function(){function e(t){ke(this,e),this.code=t.code||null,this.name=t.message||"",this.data=t.data||"",this.message="Zabbix API Error: "+this.name+" "+this.data}return Se(e,[{key:"toString",value:function(){return this.name+" "+this.data}}]),e}();function De(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var n=[],r=!0,a=!1,i=void 0;try{for(var o,u=e[Symbol.iterator]();!(r=(o=u.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{r||null==u.return||u.return()}finally{if(a)throw i}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function Pe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ee=function(){function e(t,n,r,a,i,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.url=t,this.username=n,this.password=r,this.auth="",this.version=a,this.requestOptions={basicAuth:i,withCredentials:o},this.loginPromise=null,this.loginErrorCount=0,this.maxLoginAttempts=3,this.zabbixAPICore=new we,this.getTrend=this.getTrend_ZBXNEXT1193}var t,n,r;return t=e,(n=[{key:"request",value:function(e,t){var n=this;return this.zabbixAPICore.request(this.url,e,t,this.requestOptions,this.auth).catch((function(r){return"Session terminated, re-login, please."===(a=r.data)||"Not authorised."===a||"Not authorized."===a?(n.loginErrorCount++,n.loginErrorCount>n.maxLoginAttempts?(n.loginErrorCount=0,null):n.loginOnce().then((function(){return n.request(e,t)}))):Promise.reject(r);var a}))}},{key:"loginOnce",value:function(){var e=this;return this.loginPromise||(this.loginPromise=Promise.resolve(this.login().then((function(t){return e.auth=t,e.loginPromise=null,t})))),this.loginPromise}},{key:"login",value:function(){return this.zabbixAPICore.login(this.url,this.username,this.password,this.requestOptions)}},{key:"getVersion",value:function(){return this.zabbixAPICore.getVersion(this.url,this.requestOptions)}},{key:"acknowledgeEvent",value:function(e,t){var n={eventids:e,message:t,action:this.version>=4?A.n+A.o:A.p};return this.request("event.acknowledge",n)}},{key:"getGroups",value:function(){return this.request("hostgroup.get",{output:["name"],sortfield:"name",real_hosts:!0})}},{key:"getHosts",value:function(e){var t={output:["name","host"],sortfield:"name"};return e&&(t.groupids=e),this.request("host.get",t)}},{key:"getApps",value:function(e){var t={output:"extend",hostids:e};return this.request("application.get",t)}},{key:"getItems",value:function(e,t,n){var r={output:["name","key_","value_type","hostid","status","state"],sortfield:"name",webitems:!0,filter:{},selectHosts:["hostid","name"]};return e&&(r.hostids=e),t&&(r.applicationids=t),"num"===n&&(r.filter.value_type=[0,3]),"text"===n&&(r.filter.value_type=[1,2,4]),this.request("item.get",r).then(c.f)}},{key:"getItemsByIDs",value:function(e){var t={itemids:e,output:["name","key_","value_type","hostid","status","state"],webitems:!0,selectHosts:["hostid","name"]};return this.request("item.get",t).then(c.f)}},{key:"getMacros",value:function(e){var t={output:"extend",hostids:e};return this.request("usermacro.get",t)}},{key:"getGlobalMacros",value:function(){return this.request("usermacro.get",{output:"extend",globalmacro:!0})}},{key:"getLastValue",value:function(e){var t={output:["lastvalue"],itemids:e};return this.request("item.get",t).then((function(e){return e.length?e[0].lastvalue:null}))}},{key:"getHistory",value:function(e,t,n){var r=this,a=i.a.groupBy(e,"value_type"),o=i.a.map(a,(function(e,a){var o={output:"extend",history:a,itemids:i.a.map(e,"itemid"),sortfield:"clock",sortorder:"ASC",time_from:t};return n&&(o.time_till=n),r.request("history.get",o)}));return Promise.all(o).then(i.a.flatten)}},{key:"getTrend_ZBXNEXT1193",value:function(e,t,n){var r=this,a=i.a.groupBy(e,"value_type"),o=i.a.map(a,(function(e,a){var o={output:"extend",trend:a,itemids:i.a.map(e,"itemid"),sortfield:"clock",sortorder:"ASC",time_from:t};return n&&(o.time_till=n),r.request("trend.get",o)}));return Promise.all(o).then(i.a.flatten)}},{key:"getTrend_30",value:function(e,t,n,r){var a={output:["itemid","clock",r],itemids:i.a.map(e,"itemid"),time_from:t};return n&&(a.time_till=n),this.request("trend.get",a)}},{key:"getITService",value:function(e){var t={output:"extend",serviceids:e};return this.request("service.get",t)}},{key:"getSLA",value:function(e,t,n){var r={serviceids:e,intervals:function(e,t){var n=De(e,2),r=n[0],a=n[1],i=function(e){var t=Te.a.round_interval(100*e)/1e3;return Math.max(t,A.b)}(t),o=[];r=Math.floor(r/i)*i,a=Math.ceil(a/i)*i;for(var u=r;u<=a-i;u+=i)o.push({from:u,to:u+i});return o}(t,n.intervalMs)};return this.request("service.getsla",r)}},{key:"getTriggers",value:function(e,t,n,r){var a=r.showTriggers,i=r.maintenance,o=r.timeFrom,u=r.timeTo,s={output:"extend",groupids:e,hostids:t,applicationids:n,expandDescription:!0,expandData:!0,expandComment:!0,monitored:!0,skipDependent:!0,filter:{value:1},selectGroups:["name"],selectHosts:["name","host","maintenance_status","proxy_hostid"],selectItems:["name","key_","lastvalue"],selectLastEvent:"extend",selectTags:"extend"};return a&&(s.filter.value=a),i&&(s.maintenance=!0),(o||u)&&(s.lastChangeSince=o,s.lastChangeTill=u),this.request("trigger.get",s)}},{key:"getEvents",value:function(e,t,n,r,a){var i={output:"extend",time_from:t,time_till:n,objectids:e,select_acknowledges:"extend",selectHosts:"extend",value:r};return a&&(i.limit=a,i.sortfield="clock",i.sortorder="DESC"),this.request("event.get",i)}},{key:"getAcknowledges",value:function(e){var t={output:"extend",eventids:e,preservekeys:!0,select_acknowledges:"extend",sortfield:"clock",sortorder:"DESC"};return this.request("event.get",t).then((function(e){return i.a.filter(e,(function(e){return e.acknowledges.length}))}))}},{key:"getExtendedEventData",value:function(e){var t={output:"extend",eventids:e,preservekeys:!0,select_acknowledges:"extend",selectTags:"extend",sortfield:"clock",sortorder:"DESC"};return this.request("event.get",t)}},{key:"getEventAlerts",value:function(e){var t={eventids:e,output:["eventid","message","clock","error"],selectUsers:!0};return this.request("alert.get",t)}},{key:"getAlerts",value:function(e,t,n){var r={output:"extend",itemids:e,expandDescription:!0,expandData:!0,expandComment:!0,monitored:!0,skipDependent:!0,selectLastEvent:"extend"};return(t||n)&&(r.lastChangeSince=t,r.lastChangeTill=n),this.request("trigger.get",r)}},{key:"getHostAlerts",value:function(e,t,n){var r=n.minSeverity,a=n.acknowledged,o=n.count,u=n.timeFrom,s=n.timeTo,c={output:"extend",hostids:e,min_severity:r,filter:{value:1},expandDescription:!0,expandData:!0,expandComment:!0,monitored:!0,skipDependent:!0,selectLastEvent:"extend",selectGroups:"extend",selectHosts:["host","name"]};return o&&0!==a&&1!==a&&(c.countOutput=!0),t&&t.length&&(c.applicationids=t),(u||s)&&(c.lastChangeSince=u,c.lastChangeTill=s),this.request("trigger.get",c).then((function(e){return o&&0!==a&&1!==a||(e=function(e,t){return 0===t?i.a.filter(e,(function(e){return"0"===e.lastEvent.acknowledged})):1===t?i.a.filter(e,(function(e){return"1"===e.lastEvent.acknowledged})):e}(e,a),o&&(e=e.length)),e}))}},{key:"getProxies",value:function(){return this.request("proxy.get",{output:["proxyid","host"]})}}])&&Pe(t.prototype,n),r&&Pe(t,r),e}();var Oe="SELECT CAST(itemid AS CHAR) AS metric, clock AS time_sec, value_avg AS value FROM trends_uint LIMIT 1";var Ie={historyQuery:function(e,t,n,r,a,i){var o="clock DIV ".concat(a," * ").concat(a);return"\n    SELECT CAST(itemid AS CHAR) AS metric, ".concat(o," AS time_sec, ").concat(i,"(value) AS value\n    FROM ").concat(t,"\n    WHERE itemid IN (").concat(e,")\n      AND clock > ").concat(n," AND clock < ").concat(r,"\n    GROUP BY ").concat(o,", metric\n    ORDER BY time_sec ASC\n  ")},trendsQuery:function(e,t,n,r,a,i,o){var u="clock DIV ".concat(a," * ").concat(a);return"\n    SELECT CAST(itemid AS CHAR) AS metric, ".concat(u," AS time_sec, ").concat(i,"(").concat(o,") AS value\n    FROM ").concat(t,"\n    WHERE itemid IN (").concat(e,")\n      AND clock > ").concat(n," AND clock < ").concat(r,"\n    GROUP BY ").concat(u,", metric\n    ORDER BY time_sec ASC\n  ")},testQuery:function(){return Oe}},_e="FM99999999999999999999";var je="\n  SELECT to_char(itemid, '".concat(_e,"') AS metric, clock AS time, value_avg AS value\n  FROM trends_uint LIMIT 1\n");var Me={historyQuery:function(e,t,n,r,a,i){var o="clock / ".concat(a," * ").concat(a);return"\n    SELECT to_char(itemid, '".concat(_e,"') AS metric, ").concat(o," AS time, ").concat(i,"(value) AS value\n    FROM ").concat(t,"\n    WHERE itemid IN (").concat(e,")\n      AND clock > ").concat(n," AND clock < ").concat(r,"\n    GROUP BY 1, 2\n    ORDER BY time ASC\n  ")},trendsQuery:function(e,t,n,r,a,i,o){var u="clock / ".concat(a," * ").concat(a);return"\n    SELECT to_char(itemid, '".concat(_e,"') AS metric, ").concat(u," AS time, ").concat(i,"(").concat(o,") AS value\n    FROM ").concat(t,"\n    WHERE itemid IN (").concat(e,")\n      AND clock > ").concat(n," AND clock < ").concat(r,"\n    GROUP BY 1, 2\n    ORDER BY time ASC\n  ")},testQuery:function(){return je}};function qe(e){return(qe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Be(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Re(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ne(e,t){return(Ne=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Fe(e,t,n){return(Fe="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ze(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ze(e){return(ze=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Ve="postgres",He=function(e){function t(e){var n,r,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=this,a=ze(t).call(this,e),(n=!a||"object"!==qe(a)&&"function"!=typeof a?Re(r):a).limit=e.limit||pe,n.sqlDialect=null,Fe(ze(t.prototype),"loadDBDataSource",Re(n)).call(Re(n)).then((function(){n.loadSQLDialect()})),n}var n,r,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ne(e,t)}(t,e),n=t,(r=[{key:"loadSQLDialect",value:function(){this.datasourceTypeId===Ve?this.sqlDialect=Me:this.sqlDialect=Ie}},{key:"testDataSource",value:function(){var e=this.sqlDialect.testQuery();return this.invokeSQLQuery(e)}},{key:"getHistory",value:function(e,t,n,r){var a=this,o=r.intervalMs,u=r.consolidateBy,s=Math.ceil(o/1e3),l=be.consolidateByFunc[u=u||"avg"],f=i.a.groupBy(e,"value_type"),p=i.a.map(f,(function(e,r){var o=i.a.map(e,"itemid").join(", "),u=me[r],f=a.sqlDialect.historyQuery(o,u,t,n,s,l);return f=Object(c.b)(f),a.invokeSQLQuery(f)}));return Promise.all(p).then((function(e){return i.a.flatten(e)}))}},{key:"getTrends",value:function(e,t,n,r){var a=this,o=r.intervalMs,u=r.consolidateBy,s=Math.ceil(o/1e3),l=be.consolidateByFunc[u=u||"avg"],f=i.a.groupBy(e,"value_type"),p=i.a.map(f,(function(e,r){var o=i.a.map(e,"itemid").join(", "),f=he[r],p=i.a.includes(["avg","min","max","sum"],u)?u:"avg";p=be.consolidateByTrendColumns[p];var m=a.sqlDialect.trendsQuery(o,f,t,n,s,l,p);return m=Object(c.b)(m),a.invokeSQLQuery(m)}));return Promise.all(p).then((function(e){return i.a.flatten(e)}))}},{key:"invokeSQLQuery",value:function(e){var t={refId:"A",format:"time_series",datasourceId:this.datasourceId,rawSql:e,maxDataPoints:this.limit};return Object(se.getBackendSrv)().datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{queries:[t]}}).then((function(e){var t=e.data.results;return t.A?t.A.series:null}))}}])&&Be(n.prototype,r),a&&Be(n,a),t}(ge);function Le(e){return(Le="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Qe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ge(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ue(e,t){return(Ue=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function $e(e,t,n){return($e="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=We(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function We(e){return(We=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Ye={avg:"MEAN",min:"MIN",max:"MAX",sum:"SUM",count:"COUNT"},Ze=function(e){function t(e){var n,r,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=this,a=We(t).call(this,e),(n=!a||"object"!==Le(a)&&"function"!=typeof a?Ge(r):a).retentionPolicy=e.retentionPolicy,$e(We(t.prototype),"loadDBDataSource",Ge(n)).call(Ge(n)).then((function(e){return n.influxDS=e,e})),n}var n,r,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ue(e,t)}(t,e),n=t,(r=[{key:"testDataSource",value:function(){return this.influxDS.testDatasource()}},{key:"getHistory",value:function(e,t,n,r){var a=this,o=r.intervalMs,u=r.consolidateBy,s=r.retentionPolicy,c=Math.ceil(o/1e3),l={timeFrom:t,timeTill:n};u=u||"avg";var f=i.a.groupBy(e,"value_type"),p=i.a.map(f,(function(e,t){var n=i.a.map(e,"itemid"),r=me[t],o=a.buildHistoryQuery(n,r,l,c,u,s);return a.invokeInfluxDBQuery(o)}));return Promise.all(p).then(i.a.flatten).then((function(e){return function(e){if(!e)return[];for(var t=[],n=0;n<e.length;n++){var r=e[n];if(r.error){var a="InfluxDB error: ".concat(r.error);return Promise.reject(new Error(a))}if(r&&r.series)for(var i=e[n].series,o=0;o<i.length;o++){var u=i[o],s=[];if(u.values)for(n=0;n<u.values.length;n++)s[n]=[u.values[n][1],u.values[n][0]];var c={name:u.tags.itemid,points:s};t.push(c)}}return t}(e)}))}},{key:"getTrends",value:function(e,t,n,r){return r.retentionPolicy=this.retentionPolicy,this.getHistory(e,t,n,r)}},{key:"buildHistoryQuery",value:function(e,t,n,r,a,i){var o=n.timeFrom,u=n.timeTill,s=i?'"'.concat(i,'"."').concat(t,'"'):'"'.concat(t,'"'),l="value";i&&(l=de[a]||"value_avg");var f=Ye[a]||a,p=this.buildWhereClause(e),m="SELECT ".concat(f,'("').concat(l,'") FROM ').concat(s,"\n      WHERE ").concat(p,' AND "time" >= ').concat(o,'s AND "time" <= ').concat(u,"s\n      GROUP BY time(").concat(r,'s), "itemid" fill(none)');return Object(c.b)(m)}},{key:"buildWhereClause",value:function(e){var t=e.map((function(e){return'"itemid" = \''.concat(e,"'")})).join(" OR ");return"(".concat(t,")")}},{key:"invokeInfluxDBQuery",value:function(e){return this.influxDS._seriesQuery(e).then((function(e){return e&&e.results?e.results:[]}))}}])&&Qe(n.prototype,r),a&&Qe(n,a),t}(ge);function Xe(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var n=[],r=!0,a=!1,i=void 0;try{for(var o,u=e[Symbol.iterator]();!(r=(o=u.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{r||null==u.return||u.return()}finally{if(a)throw i}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function Ke(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function Je(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var et=["getHistory","getTrend","getGroups","getHosts","getApps","getItems","getMacros","getItemsByIDs","getEvents","getAlerts","getHostAlerts","getAcknowledges","getITService","getSLA","getVersion","getProxies","getEventAlerts","getExtendedEventData"],tt=["getGroups","getHosts","getApps","getItems","getMacros","getItemsByIDs","getITService","getProxies"],nt=["getHistory","getTrend","getMacros","getItemsByIDs","getEvents","getAlerts","getHostAlerts","getAcknowledges","getITService","getVersion","login","acknowledgeEvent","getProxies","getEventAlerts","getExtendedEventData"],rt=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var r=t.url,a=t.username,i=t.password,o=t.basicAuth,u=t.withCredentials,s=t.zabbixVersion,c=t.cacheTTL,l=t.enableDirectDBConnection,f=t.dbConnectionDatasourceId,p=t.dbConnectionDatasourceName,m=t.dbConnectionRetentionPolicy;this.enableDirectDBConnection=l;var h={enabled:!0,ttl:c};if(this.cachingProxy=new oe(h),this.zabbixAPI=new Ee(r,a,i,s,o,u),this.proxyfyRequests(),this.cacheRequests(),this.bindRequests(),l){var d={dbConnectionRetentionPolicy:m};this.initDBConnector(f,p,d).then((function(){n.getHistoryDB=n.cachingProxy.proxyfyWithCache(n.dbConnector.getHistory,"getHistory",n.dbConnector),n.getTrendsDB=n.cachingProxy.proxyfyWithCache(n.dbConnector.getTrends,"getTrends",n.dbConnector)}))}}var t,n,r;return t=e,(n=[{key:"initDBConnector",value:function(e,t,n){var r=this;return ge.loadDatasource(e,t).then((function(a){var i={datasourceId:e,datasourceName:t};return"influxdb"===a.type?(i.retentionPolicy=n.dbConnectionRetentionPolicy,r.dbConnector=new Ze(i)):r.dbConnector=new He(i),r.dbConnector}))}},{key:"proxyfyRequests",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,a=et[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var i=r.value;this.zabbixAPI[i]=this.cachingProxy.proxyfy(this.zabbixAPI[i],i,this.zabbixAPI)}}catch(e){t=!0,n=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw n}}}},{key:"cacheRequests",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,a=tt[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var i=r.value;this.zabbixAPI[i]=this.cachingProxy.cacheRequest(this.zabbixAPI[i],i,this.zabbixAPI)}}catch(e){t=!0,n=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw n}}}},{key:"bindRequests",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,a=nt[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var i=r.value;this[i]=this.zabbixAPI[i].bind(this.zabbixAPI)}}catch(e){t=!0,n=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw n}}}},{key:"testDataSource",value:function(){var e,t,n=this;return this.getVersion().then((function(t){return e=t,n.login()})).then((function(){return n.enableDirectDBConnection?n.dbConnector.testDataSource():Promise.resolve()})).catch((function(e){return e instanceof ve?Promise.resolve():Promise.reject(e)})).then((function(r){return r&&(t={dsType:n.dbConnector.datasourceTypeName,dsName:n.dbConnector.datasourceName}),{zabbixVersion:e,dbConnectorStatus:t}}))}},{key:"getItemsFromTarget",value:function(e,t){var n=i.a.map(["group","host","application","item"],(function(t){return e[t].filter}));return this.getItems.apply(this,Ke(n).concat([t]))}},{key:"getHostsFromTarget",value:function(e){var t=i.a.map(["group","host","application"],(function(t){return e[t].filter}));return Promise.all([this.getHosts.apply(this,Ke(t)),this.getApps.apply(this,Ke(t))]).then((function(e){var t=Xe(e,2),n=t[0],r=t[1];return r.appFilterEmpty&&(r=[]),[n,r]}))}},{key:"getAllGroups",value:function(){return this.zabbixAPI.getGroups()}},{key:"getGroups",value:function(e){return this.getAllGroups().then((function(t){return it(t,e)}))}},{key:"getAllHosts",value:function(e){var t=this;return this.getGroups(e).then((function(e){var n=i.a.map(e,"groupid");return t.zabbixAPI.getHosts(n)}))}},{key:"getHosts",value:function(e,t){return this.getAllHosts(e).then((function(e){return it(e,t)}))}},{key:"getAllApps",value:function(e,t){var n=this;return this.getHosts(e,t).then((function(e){var t=i.a.map(e,"hostid");return n.zabbixAPI.getApps(t)}))}},{key:"getApps",value:function(e,t,n){var r=this;return this.getHosts(e,t).then((function(e){var t=i.a.map(e,"hostid");return n?r.zabbixAPI.getApps(t).then((function(e){return ot(e,n)})):{appFilterEmpty:!0,hostids:t}}))}},{key:"getAllItems",value:function(e,t,n){var r=this,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.getApps(e,t,n).then((function(e){if(e.appFilterEmpty)return r.zabbixAPI.getItems(e.hostids,void 0,a.itemtype);var t=i.a.map(e,"applicationid");return r.zabbixAPI.getItems(void 0,t,a.itemtype)})).then((function(e){return a.showDisabledItems||(e=i.a.filter(e,{status:"0"})),e})).then(this.expandUserMacro.bind(this))}},{key:"expandUserMacro",value:function(e){var t=function(e){var t=i.a.map(e,(function(e){return i.a.map(e.hosts,"hostid")}));return i.a.uniq(i.a.flatten(t))}(e);return this.getMacros(t).then((function(t){return i.a.forEach(e,(function(e){c.c(e.name)&&(e.name=c.p(e,t))})),e}))}},{key:"getItems",value:function(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};return this.getAllItems(e,t,n,a).then((function(e){return ot(e,r)}))}},{key:"getITServices",value:function(e){return this.zabbixAPI.getITService().then((function(t){return it(t,e)}))}},{key:"getTriggers",value:function(e,t,n,r,a){var o=this,u=[this.getGroups(e),this.getHosts(e,t),this.getApps(e,t,n)];return Promise.all(u).then((function(r){var a=Xe(r,3),o=a[0],u=a[1],s=a[2],c={};return n&&(c.applicationids=i.a.flatten(i.a.map(s,"applicationid"))),t&&(c.hostids=i.a.map(u,"hostid")),e&&(c.groupids=i.a.map(o,"groupid")),c})).then((function(e){return o.zabbixAPI.getTriggers(e.groupids,e.hostids,e.applicationids,r)})).then((function(e){return o.filterTriggersByProxy(e,a)}))}},{key:"filterTriggersByProxy",value:function(e,t){return this.getFilteredProxies(t).then((function(n){if(t&&"/.*/"!==t&&e){var r=n.map((function(e){return e.proxyid}));e=e.filter((function(e){for(var t=!1,n=0;n<e.hosts.length;n++){var a=e.hosts[n];r.includes(a.proxy_hostid)&&(t=!0)}return t}))}return e}))}},{key:"getFilteredProxies",value:function(e){return this.zabbixAPI.getProxies().then((function(t){return t.forEach((function(e){return e.name=e.host})),it(t,e)}))}},{key:"getHistoryTS",value:function(e,t,n){var r=this,a=Xe(t,2),i=a[0],o=a[1];return this.enableDirectDBConnection?this.getHistoryDB(e,i,o,n).then((function(t){return r.dbConnector.handleGrafanaTSResponse(t,e)})):this.zabbixAPI.getHistory(e,i,o).then((function(t){return ae.handleHistory(t,e)}))}},{key:"getTrends",value:function(e,t,n){var r=this,a=Xe(t,2),i=a[0],o=a[1];if(this.enableDirectDBConnection)return this.getTrendsDB(e,i,o,n).then((function(t){return r.dbConnector.handleGrafanaTSResponse(t,e)}));var u=n.consolidateBy||n.valueType;return this.zabbixAPI.getTrend(e,i,o).then((function(t){return ae.handleTrends(t,e,u)})).then(ae.sortTimeseries)}},{key:"getHistoryText",value:function(e,t,n){var r=Xe(t,2),a=r[0],i=r[1];return e.length?this.zabbixAPI.getHistory(e,a,i).then((function(t){return"table"===n.resultFormat?ae.handleHistoryAsTable(t,e,n):ae.handleText(t,e,n)})):Promise.resolve([])}},{key:"getSLA",value:function(e,t,n,r){var a=e;r.isOldVersion&&(a=i.a.filter(a,{serviceid:n.itservice.serviceid}));var o=i.a.map(a,"serviceid");return this.zabbixAPI.getSLA(o,t,r).then((function(e){return i.a.map(o,(function(t){var r=i.a.find(a,{serviceid:t});return ae.handleSLAResponse(r,n.slaProperty,e)}))}))}}])&&Je(t.prototype,n),r&&Je(t,r),e}();function at(e,t){var n=c.a(t);return i.a.filter(e,(function(e){return n.test(e.name)}))}function it(e,t){return c.j(t)?at(e,t):function(e,t){var n=i.a.find(e,{name:t});return n?[n]:[]}(e,t)}function ot(e,t){return c.j(t)?at(e,t):function(e,t){var n=i.a.filter(e,{name:t});return n||[]}(e,t)}var ut=n(7);function st(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var n=[],r=!0,a=!1,i=void 0;try{for(var o,u=e[Symbol.iterator]();!(r=(o=u.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{r||null==u.return||u.return()}finally{if(a)throw i}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function ct(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var lt=3,ft=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.templateSrv=n,this.zabbixAlertingSrv=r,this.enableDebugLog="development"===u.a.buildInfo.env,this.replaceTemplateVars=i.a.partial(gt,this.templateSrv),this.name=t.name,this.url=t.url,this.basicAuth=t.basicAuth,this.withCredentials=t.withCredentials;var a=m(t.jsonData);this.username=a.username,this.password=a.password,this.trends=a.trends,this.trendsFrom=a.trendsFrom||"7d",this.trendsRange=a.trendsRange||"4d";var o=a.cacheTTL||"1h";this.cacheTTL=c.l(o),this.alertingEnabled=a.alerting,this.addThresholds=a.addThresholds,this.alertingMinSeverity=a.alertingMinSeverity||A.i,this.disableReadOnlyUsersAck=a.disableReadOnlyUsersAck,this.zabbixVersion=a.zabbixVersion||lt,this.enableDirectDBConnection=a.dbConnectionEnable||!1,this.dbConnectionDatasourceId=a.dbConnectionDatasourceId,this.dbConnectionDatasourceName=a.dbConnectionDatasourceName,this.dbConnectionRetentionPolicy=a.dbConnectionRetentionPolicy;var s={url:this.url,username:this.username,password:this.password,basicAuth:this.basicAuth,withCredentials:this.withCredentials,zabbixVersion:this.zabbixVersion,cacheTTL:this.cacheTTL,enableDirectDBConnection:this.enableDirectDBConnection,dbConnectionDatasourceId:this.dbConnectionDatasourceId,dbConnectionDatasourceName:this.dbConnectionDatasourceName,dbConnectionRetentionPolicy:this.dbConnectionRetentionPolicy};this.zabbix=new rt(s)}var t,n,r;return e.$inject=["instanceSettings","templateSrv","zabbixAlertingSrv"],t=e,(n=[{key:"query",value:function(e){var t=this;this.alertingEnabled&&this.alertQuery(e).then((function(n){t.zabbixAlertingSrv.setPanelAlertState(e.panelId,n.state),t.zabbixAlertingSrv.removeZabbixThreshold(e.panelId),t.addThresholds&&i.a.forEach(n.thresholds,(function(n){t.zabbixAlertingSrv.setPanelThreshold(e.panelId,n)}))}));var n=i.a.map(e.targets,(function(n){if(n.hide)return[];var r=Math.ceil(s.parse(e.range.from)/1e3),a=Math.ceil(s.parse(e.range.to)/1e3);e.scopedVars=Object.assign({},e.scopedVars,c.i(e.range));var o=i.a.cloneDeep(n);o=l(o),t.replaceTargetVariables(o,e);var u=pt(o.functions,"Time");if(u.length){var f=st(c.q(u)([r,a]),2);r=f[0],a=f[1]}var p=[r,a],m=t.isUseTrends(p);return o.mode&&o.mode!==A.e&&o.mode!==A.f?o.mode===A.c?o.itemids?t.queryItemIdData(o,p,m,e):[]:o.mode===A.d?t.queryITServiceData(o,p,e):o.mode===A.g?t.queryTriggersData(o,p):[]:o.group&&o.host&&o.item?o.mode&&o.mode!==A.e?o.mode===A.f?t.queryTextData(o,p):void 0:t.queryNumericData(o,p,m,e):[]}));return Promise.all(i.a.flatten(n)).then(i.a.flatten).then((function(e){return{data:e}}))}},{key:"queryNumericData",value:function(e,t,n,r){var a,i,o=this;return this.zabbix.getItemsFromTarget(e,{itemtype:"num"}).then((function(i){return a=(new Date).getTime(),o.queryNumericDataForItems(i,e,t,n,r)})).then((function(e){return i=(new Date).getTime(),o.enableDebugLog&&console.debug("Datasource::Performance Query Time (".concat(o.name,"): ").concat(i-a)),e}))}},{key:"queryNumericDataForItems",value:function(e,t,n,r,a){var o=this;return a.valueType=this.getTrendValueType(t),a.consolidateBy=function(e){var t,n=i.a.find(e.functions,(function(e){return"consolidateBy"===e.def.name}));return n&&n.params&&n.params.length&&(t=n.params[0]),t}(t)||a.valueType,(r?this.zabbix.getTrends(e,n,a):this.zabbix.getHistoryTS(e,n,a)).then((function(e){return o.applyDataProcessingFunctions(e,t)})).then((function(e){return function(e,t){var n=Y.aggregationFunctions.avg,r=Y.aggregationFunctions[t.consolidateBy]||n;return i.a.map(e,(function(e){return e.datapoints.length>t.maxDataPoints&&(e.datapoints=Y.groupBy(t.interval,r,e.datapoints)),e}))}(e,a)}))}},{key:"getTrendValueType",value:function(e){var t=i.a.map(k().Trends,"name"),n=i.a.find(e.functions,(function(e){return i.a.includes(t,e.def.name)}));return n?n.params[0]:"avg"}},{key:"applyDataProcessingFunctions",value:function(e,t){var n=pt(t.functions,"Transform"),r=pt(t.functions,"Aggregate"),a=pt(t.functions,"Filter"),o=pt(t.functions,"Alias");if(e=i.a.cloneDeep(i.a.map(e,(function(e){return e.datapoints=c.q(n)(e.datapoints),e}))),a.length&&(e=c.q(a)(e)),r.length){var u=i.a.map(e,"datapoints");u=c.q(r)(u);var s=i.a.map(k().Aggregate,"name");e=[{target:i.a.findLast(t.functions,(function(e){return i.a.includes(s,e.def.name)})).text,datapoints:u}]}return i.a.forEach(e,c.q(o)),this.applyTimeShiftFunction(e,t),e}},{key:"applyTimeShiftFunction",value:function(e,t){var n=i.a.find(t.functions,(function(e){return"timeShift"===e.def.name}));if(n){var r=n.params[0];i.a.forEach(e,(function(e){e.datapoints=Y.unShiftTimeSeries(r,e.datapoints)}))}}},{key:"queryTextData",value:function(e,t){var n=this;return this.zabbix.getItemsFromTarget(e,{itemtype:"text"}).then((function(r){return n.zabbix.getHistoryText(r,t,e)}))}},{key:"queryItemIdData",value:function(e,t,n,r){var a=this,o=e.itemids;return o=this.templateSrv.replace(o,r.scopedVars,dt),(o=i.a.map(o.split(","),(function(e){return e.trim()})))?this.zabbix.getItemsByIDs(o).then((function(i){return a.queryNumericDataForItems(i,e,t,n,r)})):[]}},{key:"queryITServiceData",value:function(e,t,n){var r,a=this;return e.hide||!e.itservice&&!e.itServiceFilter||!e.slaProperty?[]:(n.isOldVersion=e.itservice&&!e.itServiceFilter,r=n.isOldVersion?"/.*/":this.replaceTemplateVars(e.itServiceFilter,n.scopedVars),this.zabbix.getITServices(r).then((function(r){return a.zabbix.getSLA(r,t,e,n)})).then((function(t){return a.applyDataProcessingFunctions(t,e)})))}},{key:"queryTriggersData",value:function(e,t){var n=this,r=st(t,2),a=r[0],o=r[1];return this.zabbix.getHostsFromTarget(e).then((function(r){var u=st(r,2),s=u[0],c=u[1];if(s.length){var l=i.a.map(s,"hostid"),f=i.a.map(c,"applicationid"),p={minSeverity:e.triggers.minSeverity,acknowledged:e.triggers.acknowledged,count:e.triggers.count,timeFrom:a,timeTo:o},m=e.group.filter;return Promise.all([n.zabbix.getHostAlerts(l,f,p),n.zabbix.getGroups(m)]).then((function(e){var n=st(e,2),r=n[0],a=n[1];return ae.handleTriggersResponse(r,a,t)}))}return Promise.resolve([])}))}},{key:"testDatasource",value:function(){return this.zabbix.testDataSource().then((function(e){var t=e.zabbixVersion,n=e.dbConnectorStatus,r="Zabbix API version: ".concat(t);return n&&(r+=", DB connector type: ".concat(n.dsType)),{status:"success",title:"Success",message:r}})).catch((function(e){return e instanceof Ce?{status:"error",title:e.message,message:e.message}:e.data&&e.data.message?{status:"error",title:"Connection failed",message:"Connection failed: "+e.data.message}:"string"==typeof e?{status:"error",title:"Connection failed",message:"Connection failed: "+e}:(console.log(e),{status:"error",title:"Connection failed",message:"Could not connect to given url"})}))}},{key:"getVersion",value:function(){return this.zabbix.getVersion().then((function(e){var t=c.o(e);return t?t.major:null}))}},{key:"metricFindQuery",value:function(e){var t,n=i.a.cloneDeep(e);if(!e)return Promise.resolve([]);"string"==typeof e&&(n=c.m(e));for(var r=0,a=["group","host","application","item"];r<a.length;r++){var o=a[r];n[o]=this.replaceTemplateVars(n[o],{})}switch(n.queryType){case ut.a.Group:t=this.zabbix.getGroups(n.group);break;case ut.a.Host:t=this.zabbix.getHosts(n.group,n.host);break;case ut.a.Application:t=this.zabbix.getApps(n.group,n.host,n.application);break;case ut.a.Item:t=this.zabbix.getItems(n.group,n.host,n.application,n.item);break;default:t=Promise.resolve([])}return t.then((function(e){return i.a.map(e,mt)}))}},{key:"annotationQuery",value:function(e){var t=this,n=e.range||e.rangeRaw,r=Math.ceil(s.parse(n.from)/1e3),a=Math.ceil(s.parse(n.to)/1e3),o=e.annotation,u=o.showOkEvents?A.j:A.l,l={showTriggers:A.k,hideHostsInMaintenance:!1};return this.zabbix.getTriggers(this.replaceTemplateVars(o.group,{}),this.replaceTemplateVars(o.host,{}),this.replaceTemplateVars(o.application,{}),l).then((function(e){var n=t.replaceTemplateVars(o.trigger,{});c.j(n)?e=i.a.filter(e,(function(e){return c.a(n).test(e.description)})):n&&(e=i.a.filter(e,(function(e){return e.description===n}))),e=i.a.filter(e,(function(e){return Number(e.priority)>=Number(o.minseverity)}));var s=i.a.map(e,"triggerid");return t.zabbix.getEvents(s,r,a,u).then((function(t){var n=i.a.keyBy(e,"triggerid");return o.hideAcknowledged&&(t=i.a.filter(t,(function(e){return!e.acknowledges.length}))),i.a.map(t,(function(e){var t;o.showHostname&&(t=i.a.map(e.hosts,"name"));var r=Number(e.value)?"Problem":"OK",a=c.g(e.acknowledges);return{annotation:o,time:1e3*e.clock,title:r,tags:t,text:n[e.objectid].description+a}}))}))}))}},{key:"alertQuery",value:function(e){var t,n=this,r=(t=e.targets,i.a.filter(t,(function(e){return!(e.hide||!e.group||!e.host||!e.item)}))),a=i.a.map(r,(function(t){var r=i.a.cloneDeep(t);return r=l(r),n.replaceTargetVariables(r,e),n.zabbix.getItemsFromTarget(r,{itemtype:"num"})}));return Promise.all(a).then((function(e){var t=i.a.flatten(e),r=i.a.map(t,"itemid");return 0===r.length?[]:n.zabbix.getAlerts(r)})).then((function(t){if(!(t=i.a.filter(t,(function(e){return e.priority>=n.alertingMinSeverity})))||0===t.length)return{};var r="ok";i.a.filter(t,{value:"1"}).length&&(r="alerting");var a=i.a.map(t,(function(e){return function(e){var t=e.match(/.*[<>=]{1,2}([\d\.]+)/);if(t&&t.length>=2){var n=t[1];return n=Number(n)}return null}(e.expression)}));return{panelId:e.panelId,state:r,thresholds:a}}))}},{key:"replaceTargetVariables",value:function(e,t){var n=this;i.a.forEach(["group","host","application","item"],(function(r){e[r]&&e[r].filter&&(e[r].filter=n.replaceTemplateVars(e[r].filter,t.scopedVars))})),e.textFilter=this.replaceTemplateVars(e.textFilter,t.scopedVars),i.a.forEach(e.functions,(function(e){e.params=i.a.map(e.params,(function(e){return"number"==typeof e?+n.templateSrv.replace(e.toString(),t.scopedVars):n.templateSrv.replace(e,t.scopedVars)}))}))}},{key:"isUseTrends",value:function(e){var t=st(e,2),n=t[0],r=t[1],a=Math.ceil(s.parse("now-"+this.trendsFrom)/1e3),i=Math.ceil(c.l(this.trendsRange)/1e3);return this.trends&&(n<a||r-n>i)}}])&&ct(t.prototype,n),r&&ct(t,r),e}();function pt(e,t){var n=i.a.map(k()[t],"name"),r=i.a.filter(e,(function(e){return i.a.includes(n,e.def.name)}));return i.a.map(r,(function(e){return T(e.def,e.params).bindFunction(Y.metricFunctions)}))}function mt(e){return{text:e.name,expandable:!1}}function ht(e){return"string"==typeof e?c.d(e):"("+i.a.map(e,c.d).join("|")+")"}function dt(e){return"string"==typeof e?e:e.join(",")}function gt(e,t,n){var r=e.replace(t,n,ht);return t===r||c.j(r)||(r="/^"+r+"$/"),r}function vt(e){return(vt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function yt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function bt(e){return(bt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function xt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Tt(e,t){return(Tt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}i.a.includes||(i.a.includes=i.a.contains),i.a.keyBy||(i.a.keyBy=i.a.indexBy);var kt=function(e){function t(e,n,r,a,o){var u,s,c;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s=this,c=bt(t).call(this,e,n),(u=!c||"object"!==vt(c)&&"function"!=typeof c?xt(s):c).zabbix=u.datasource.zabbix,u.replaceTemplateVars=u.datasource.replaceTemplateVars,u.templateSrv=o,u.editorModes=[{value:"num",text:"Metrics",mode:A.e},{value:"text",text:"Text",mode:A.f},{value:"itservice",text:"IT Services",mode:A.d},{value:"itemid",text:"Item ID",mode:A.c},{value:"triggers",text:"Triggers",mode:A.g}],u.$scope.editorMode={METRICS:A.e,TEXT:A.f,ITSERVICE:A.d,ITEMID:A.c,TRIGGERS:A.g},u.slaPropertyList=[{name:"Status",property:"status"},{name:"SLA",property:"sla"},{name:"OK time",property:"okTime"},{name:"Problem time",property:"problemTime"},{name:"Down time",property:"downtimeTime"}],u.ackFilters=[{text:"all triggers",value:2},{text:"unacknowledged",value:0},{text:"acknowledged",value:1}],u.resultFormats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],u.triggerSeverity=A.m,u.getGroupNames=i.a.bind(u.getMetricNames,xt(u),"groupList"),u.getHostNames=i.a.bind(u.getMetricNames,xt(u),"hostList",!0),u.getApplicationNames=i.a.bind(u.getMetricNames,xt(u),"appList"),u.getItemNames=i.a.bind(u.getMetricNames,xt(u),"itemList"),u.getITServices=i.a.bind(u.getMetricNames,xt(u),"itServiceList"),u.getVariables=i.a.bind(u.getTemplateVariables,xt(u)),r.$on("template-variable-value-updated",(function(){return u.onVariableChange()})),e.$on("typeahead-updated",(function(){u.onTargetBlur()})),u.init=function(){var e=this.target;e=l(e);var t={metric:{},oldTarget:i.a.cloneDeep(this.target),queryOptionsText:this.renderQueryOptionsText()};i.a.defaults(this,t);var n={mode:A.e,group:{filter:""},host:{filter:""},application:{filter:""},item:{filter:""},functions:[],triggers:{count:!0,minSeverity:3,acknowledged:2},options:{showDisabledItems:!1,skipEmptyValues:!1},table:{skipEmptyValues:!1}};i.a.defaults(e,n),e.functions=i.a.map(e.functions,(function(e){return T(e.def,e.params)})),e.mode===A.e||e.mode===A.f||e.mode===A.g?this.initFilters():e.mode===A.d&&(i.a.defaults(e,{slaProperty:{name:"SLA",property:"sla"}}),this.suggestITServices())},u.init(),u.queryOptionsText=u.renderQueryOptionsText(),u}var n,r,a;return t.$inject=["$scope","$injector","$rootScope","$sce","templateSrv"],function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Tt(e,t)}(t,e),n=t,(r=[{key:"initFilters",value:function(){var e=i.a.find(this.editorModes,{mode:this.target.mode});return e=e?e.value:null,Promise.all([this.suggestGroups(),this.suggestHosts(),this.suggestApps(),this.suggestItems(e)])}},{key:"getMetricNames",value:function(e,t){var n=i.a.uniq(i.a.map(this.metric[e],"name"));return i.a.forEach(this.templateSrv.variables,(function(e){n.unshift("$"+e.name)})),t&&n.unshift("/.*/"),n}},{key:"getTemplateVariables",value:function(){return i.a.map(this.templateSrv.variables,(function(e){return"$"+e.name}))}},{key:"suggestGroups",value:function(){var e=this;return this.zabbix.getAllGroups().then((function(t){return e.metric.groupList=t,t}))}},{key:"suggestHosts",value:function(){var e=this,t=this.replaceTemplateVars(this.target.group.filter);return this.zabbix.getAllHosts(t).then((function(t){return e.metric.hostList=t,t}))}},{key:"suggestApps",value:function(){var e=this,t=this.replaceTemplateVars(this.target.group.filter),n=this.replaceTemplateVars(this.target.host.filter);return this.zabbix.getAllApps(t,n).then((function(t){return e.metric.appList=t,t}))}},{key:"suggestItems",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"num",n=this.replaceTemplateVars(this.target.group.filter),r=this.replaceTemplateVars(this.target.host.filter),a=this.replaceTemplateVars(this.target.application.filter),i={itemtype:t,showDisabledItems:this.target.options.showDisabledItems};return this.zabbix.getAllItems(n,r,a,i).then((function(t){return e.metric.itemList=t,t}))}},{key:"suggestITServices",value:function(){var e=this;return this.zabbix.getITService().then((function(t){return e.metric.itServiceList=t,t}))}},{key:"isRegex",value:function(e){return c.j(e)}},{key:"isVariable",value:function(e){return c.k(e,this.templateSrv.variables)}},{key:"onTargetBlur",value:function(){var e=i.a.cloneDeep(this.target);i.a.isEqual(this.oldTarget,this.target)||(this.oldTarget=e,this.targetChanged())}},{key:"onVariableChange",value:function(){this.isContainsVariables()&&this.targetChanged()}},{key:"isContainsVariables",value:function(){var e=this;return i.a.some(["group","host","application"],(function(t){return!(!e.target[t]||!e.target[t].filter)&&c.k(e.target[t].filter,e.templateSrv.variables)}))}},{key:"parseTarget",value:function(){}},{key:"validateTarget",value:function(){}},{key:"targetChanged",value:function(){this.initFilters(),this.parseTarget(),this.panelCtrl.refresh()}},{key:"addFunction",value:function(e){var t=T(e);t.added=!0,this.target.functions.push(t),this.moveAliasFuncLast(),(t.params.length&&t.added||0===t.def.params.length)&&this.targetChanged()}},{key:"removeFunction",value:function(e){this.target.functions=i.a.without(this.target.functions,e),this.targetChanged()}},{key:"moveFunction",value:function(e,t){var n=this.target.functions.indexOf(e);i.a.move(this.target.functions,n,n+t),this.targetChanged()}},{key:"moveAliasFuncLast",value:function(){var e=i.a.find(this.target.functions,(function(e){return"Alias"===e.def.category}));e&&(this.target.functions=i.a.without(this.target.functions,e),this.target.functions.push(e))}},{key:"toggleQueryOptions",value:function(){this.showQueryOptions=!this.showQueryOptions}},{key:"onQueryOptionChange",value:function(){this.queryOptionsText=this.renderQueryOptionsText(),this.onTargetBlur()}},{key:"renderQueryOptionsText",value:function(){var e={showDisabledItems:"Show disabled items",skipEmptyValues:"Skip empty values"},t=[];return i.a.forOwn(this.target.options,(function(n,r){n&&(!0===n?t.push(e[r]):t.push(e[r]+" = "+n))})),"Options: "+t.join(", ")}},{key:"switchEditorMode",value:function(e){this.target.mode=e,this.init(),this.targetChanged()}}])&&yt(n.prototype,r),a&&yt(n,a),t}(r.QueryCtrl);function At(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var St,wt,Ct,Dt,Pt=["mysql","postgres","influxdb"],Et=[{name:"2.x",value:2},{name:"3.x",value:3},{name:"4.x",value:4}],Ot={trends:!1,dbConnectionEnable:!1,dbConnectionDatasourceId:null,alerting:!1,addThresholds:!1,alertingMinSeverity:3,disableReadOnlyUsersAck:!1,zabbixVersion:3},It=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.current.jsonData=m(this.current.jsonData),i.a.defaults(this.current.jsonData,Ot),this.dbConnectionDatasourceId=this.current.jsonData.dbConnectionDatasourceId,this.dbDataSources=this.getSupportedDBDataSources(),this.zabbixVersions=i.a.cloneDeep(Et),this.autoDetectZabbixVersion(),this.dbConnectionDatasourceId||this.loadCurrentDBDatasource()}var t,n,r;return t=e,(n=[{key:"getSupportedDBDataSources",value:function(){var e=Object(se.getDataSourceSrv)().getAll();return i.a.filter(e,(function(e){return i.a.includes(Pt,e.type)}))}},{key:"getCurrentDatasourceType",value:function(){var e=this.dbConnectionDatasourceId,t=i.a.find(this.dbDataSources,{id:e});return t?t.type:null}},{key:"loadCurrentDBDatasource",value:function(){var e=this,t=this.current.jsonData.dbConnectionDatasourceName;Object(se.getDataSourceSrv)().loadDatasource(t).then((function(t){t&&(e.dbConnectionDatasourceId=t.id)}))}},{key:"autoDetectZabbixVersion",value:function(){var e=this;this.current.id&&Object(se.getDataSourceSrv)().loadDatasource(this.current.name).then((function(e){return e.getVersion()})).then((function(t){t&&(i.a.find(Et,["value",t])||e.zabbixVersions.push({name:t+".x",value:t}),e.current.jsonData.zabbixVersion=t)}))}},{key:"onDBConnectionDatasourceChange",value:function(){this.current.jsonData.dbConnectionDatasourceId=this.dbConnectionDatasourceId}}])&&At(t.prototype,n),r&&At(t,r),e}(),_t=n(0),jt=n.n(_t),Mt=n(12),qt=n(23),Bt=function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e},Rt=function(){return(Rt=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},Nt=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(r=Object.getOwnPropertySymbols(e);a<r.length;a++)t.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(n[r[a]]=e[r[a]])}return n},Ft=RegExp("^"+c.r.source),zt=((St={})[Mt.EventsWithValidation.onBlur]=[{rule:function(e){return!e||!(e.length>1&&"/"===e[0]&&"/"!==e[e.length-1])},errorMessage:"Not a valid regex"},{rule:function(e){return"*"!==e},errorMessage:"Wildcards not supported. Use /.*/ instead"}],St),Vt=Object(Mt.withTheme)((function(e){var t,n=e.theme,r=e.value,a=(e.ref,e.validationEvents,Nt(e,["theme","value","ref","validationEvents"])),i=function(e){return{inputRegex:Object(qt.css)(wt||(wt=Bt(["\n    color: ","\n  "],["\n    color: ","\n  "])),e.colors.orange),inputVariable:Object(qt.css)(Ct||(Ct=Bt(["\n    color: ","\n  "],["\n    color: ","\n  "])),e.colors.variable)}}(n);return Ft.test(r)&&(t=i.inputVariable),Object(c.j)(r)&&(t=i.inputRegex),jt.a.createElement(Mt.Input,Rt({className:t,value:r,validationEvents:zt},a))})),Ht=(Dt=function(e,t){return(Dt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}Dt(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),Lt=function(){return(Lt=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},Qt=function(e){function t(t){var n=e.call(this,t)||this;if(n.queryTypes=[{value:ut.a.Group,label:"Group"},{value:ut.a.Host,label:"Host"},{value:ut.a.Application,label:"Application"},{value:ut.a.Item,label:"Item"}],n.defaults={selectedQueryType:{value:ut.a.Group,label:"Group"},queryType:ut.a.Group,group:"/.*/",host:"",application:"",item:""},n.handleQueryUpdate=function(e,t){var r=e.currentTarget.value;n.setState((function(e){var n=Lt({},e);return n[t]=r,Lt({},n)}))},n.handleQueryChange=function(){var e=n.state,t=e.queryType,r={queryType:t,group:e.group,host:e.host,application:e.application,item:e.item};n.props.onChange(r,"Zabbix - "+t)},n.handleQueryTypeChange=function(e){n.setState(Lt(Lt({},n.state),{selectedQueryType:e,queryType:e.value}));var t=n.state,r=t.group,a=t.host,i=t.application,o=t.item,u=e.value,s={queryType:u,group:r,host:a,application:i,item:o};n.props.onChange(s,"Zabbix - "+u)},n.props.query&&"string"==typeof n.props.query){var r=Object(c.m)(n.props.query),a=n.getSelectedQueryType(r.queryType);n.state=Lt({selectedQueryType:a,legacyQuery:n.props.query},r)}else if(n.props.query){r=n.props.query,a=n.getSelectedQueryType(r.queryType);n.state=Lt(Lt(Lt({},n.defaults),r),{selectedQueryType:a})}else n.state=n.defaults;return n}return Ht(t,e),t.prototype.getSelectedQueryType=function(e){return this.queryTypes.find((function(t){return t.value===e}))},t.prototype.render=function(){var e=this,t=this.state,n=t.selectedQueryType,r=t.legacyQuery,a=t.group,i=t.host,o=t.application,u=t.item;return jt.a.createElement(jt.a.Fragment,null,jt.a.createElement("div",{className:"gf-form max-width-21"},jt.a.createElement(Mt.FormLabel,{width:10},"Query Type"),jt.a.createElement(Mt.Select,{width:11,value:n,options:this.queryTypes,onChange:this.handleQueryTypeChange})),jt.a.createElement("div",{className:"gf-form-inline"},jt.a.createElement("div",{className:"gf-form max-width-30"},jt.a.createElement(Mt.FormLabel,{width:10},"Group"),jt.a.createElement(Vt,{value:a,onChange:function(t){return e.handleQueryUpdate(t,"group")},onBlur:this.handleQueryChange})),n.value!==ut.a.Group&&jt.a.createElement("div",{className:"gf-form max-width-30"},jt.a.createElement(Mt.FormLabel,{width:10},"Host"),jt.a.createElement(Vt,{value:i,onChange:function(t){return e.handleQueryUpdate(t,"host")},onBlur:this.handleQueryChange}))),(n.value===ut.a.Application||n.value===ut.a.Item)&&jt.a.createElement("div",{className:"gf-form-inline"},jt.a.createElement("div",{className:"gf-form max-width-30"},jt.a.createElement(Mt.FormLabel,{width:10},"Application"),jt.a.createElement(Vt,{value:o,onChange:function(t){return e.handleQueryUpdate(t,"application")},onBlur:this.handleQueryChange})),n.value===ut.a.Item&&jt.a.createElement("div",{className:"gf-form max-width-30"},jt.a.createElement(Mt.FormLabel,{width:10},"Item"),jt.a.createElement(Vt,{value:u,onChange:function(t){return e.handleQueryUpdate(t,"item")},onBlur:this.handleQueryChange}))),r&&jt.a.createElement("div",{className:"gf-form"},jt.a.createElement(Mt.FormLabel,{width:10,tooltip:"Original query string, read-only"},"Legacy Query"),jt.a.createElement(Mt.Input,{value:r,readOnly:!0})))},t}(_t.PureComponent),Gt=n(18),Ut=n.n(Gt);function $t(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Wt=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.dashboardSrv=t}var t,n,r;return e.$inject=["dashboardSrv"],t=e,(n=[{key:"isFullScreen",value:function(){return this.getDashboardModel().meta.fullscreen}},{key:"setPanelAlertState",value:function(e,t){var n,r=i.a.filter(d()(".panel-container"),(function(e){return e.clientHeight&&e.clientWidth})),a=this.getPanelModels();if((n=this.isFullScreen()?0:i.a.findIndex(a,(function(t){return t.id===e})))>=0&&!r[n].className.includes("panel-container--absolute")){var o="panel-has-alert panel-alert-state--ok panel-alert-state--alerting";d()(r[n]).removeClass(o),t&&(o="panel-has-alert panel-alert-state--"+t,d()(r[n]).addClass(o))}}},{key:"getDashboardModel",value:function(){return this.dashboardSrv.dash||this.dashboardSrv.dashboard}},{key:"getPanelModels",value:function(){return i.a.filter(this.getDashboardModel().panels,(function(e){return"row"!==e.type}))}},{key:"getPanelModel",value:function(e){var t=this.getPanelModels();return i.a.find(t,(function(t){return t.id===e}))}},{key:"setPanelThreshold",value:function(e,t){var n=this.getPanelModel(e),r=i.a.find(n.thresholds,{value:t});if(n&&"graph"===n.type&&!r){var a={colorMode:"custom",fill:!1,line:!0,lineColor:"rgb(255, 0, 0)",op:"gt",value:t,source:"zabbix"};n.thresholds.push(a)}}},{key:"removeZabbixThreshold",value:function(e){var t=this.getPanelModel(e);t&&"graph"===t.type&&(t.thresholds=i.a.filter(t.thresholds,(function(e){return"zabbix"!==e.source})))}}])&&$t(t.prototype,n),r&&$t(t,r),e}();Ut.a.module("grafana.services").service("zabbixAlertingSrv",Wt),Ut.a.module("grafana.directives").directive("addMetricFunction",["$compile",function(e){return{link:function(t,n){var r=k(),a=function(e){return i.a.reduce(e,(function(e,t){return i.a.each(t,(function(t){e.push(t.name)})),e}),[])}(r);t.functionMenu=function(e){return i.a.map(e,(function(e,t){return{text:t,submenu:i.a.map(e,(function(e){return{text:e.name,click:"ctrl.addFunction('"+e.name+"')"}}))}}))}(r);var o=d()('<input type="text" class="gf-form-input" spellcheck="false" style="display:none"></input>'),u=d()('<a  class="gf-form-label tight-form-func dropdown-toggle query-part" tabindex="1" gf-dropdown="functionMenu" data-toggle="dropdown"><i class="fa fa-plus"></i></a>');o.appendTo(n),u.appendTo(n),o.attr("data-provide","typeahead"),o.typeahead({source:a,minLength:1,items:10,updater:function(e){var n=function(e){return v[e]}(e);if(n||(e=e.toLowerCase(),n=i.a.find(a,(function(t){return 0===t.toLowerCase().indexOf(e)}))))return t.$apply((function(){t.ctrl.addFunction(n)})),o.trigger("blur"),""}}),u.click((function(){u.hide(),o.show(),o.focus()})),o.keyup((function(){n.toggleClass("open",""===o.val())})),o.blur((function(){setTimeout((function(){o.val(""),o.hide(),u.show(),n.removeClass("open")}),200)})),e(n.contents())(t)}}}]);var Yt=n(21),Zt=n.n(Yt);var Xt=function(e){return e.description?jt.a.createElement("span",{className:"pointer fa fa-question-circle",onClick:e.onDescriptionShow}):jt.a.createElement("span",{className:"pointer fa fa-question-circle",onClick:function(){window.open("https://alexanderzobnin.github.io/grafana-zabbix/reference/functions/#"+e.name,"_blank")}})},Kt=function(e){var t=e.func,n=e.onMoveLeft,r=e.onMoveRight,a=e.onRemove,i=e.onDescriptionShow;return jt.a.createElement("div",{style:{display:"flex",width:"60px",justifyContent:"space-between"}},jt.a.createElement("span",{className:"pointer fa fa-arrow-left",onClick:function(){return n(t)}}),jt.a.createElement(Xt,{name:t.def.name,description:t.def.description,onDescriptionShow:i}),jt.a.createElement("span",{className:"pointer fa fa-remove",onClick:function(){return a(t)}}),jt.a.createElement("span",{className:"pointer fa fa-arrow-right",onClick:function(){return r(t)}}))},Jt=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),en=function(){return(en=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},tn=function(e){function t(t){var n=e.call(this,t)||this;return n.triggerRef=jt.a.createRef(),n.renderContent=function(e){var t=e.updatePopperPosition,r=n.props,a=r.onMoveLeft,i=r.onMoveRight,o=r.func.def,u=o.name,s=o.description;return n.state.showingDescription?jt.a.createElement("div",{style:{overflow:"auto",maxHeight:"30rem",textAlign:"left",fontWeight:"normal"}},jt.a.createElement("h4",{style:{color:"white"}}," ",u," "),jt.a.createElement("div",null,s),"/>"):jt.a.createElement(Kt,en({},n.props,{onMoveLeft:function(){a(n.props.func),t()},onMoveRight:function(){i(n.props.func),t()},onDescriptionShow:function(){n.setState({showingDescription:!0},(function(){t()}))}}))},n.state={showingDescription:!1},n}return Jt(t,e),t.prototype.render=function(){var e=this;return jt.a.createElement(Mt.PopoverController,{content:this.renderContent,placement:"top",hideAfter:300},(function(t,n,r){return jt.a.createElement(jt.a.Fragment,null,e.triggerRef&&jt.a.createElement(Mt.Popover,en({},r,{referenceElement:e.triggerRef.current,wrapperClassName:"popper",className:"popper__background",onMouseLeave:function(){e.setState({showingDescription:!1}),n()},onMouseEnter:t,renderArrow:function(e){var t=e.arrowProps,n=e.placement;return jt.a.createElement("div",en({className:"popper__arrow","data-placement":n},t))}})),jt.a.createElement("span",{ref:e.triggerRef,onClick:r.show?n:t,onMouseLeave:function(){n(),e.setState({showingDescription:!1})},style:{cursor:"pointer"}},e.props.func.def.name))}))},t}(jt.a.PureComponent);function nn(e,t){var n='<input type="text" style="display:none" class="input-small tight-form-func-param"></input>';return{restrict:"A",link:function(r,a){var o=d()('\n    <zbx-function-editor\n      func="func"\n      onRemove="ctrl.handleRemoveFunction"\n      onMoveLeft="ctrl.handleMoveLeft"\n      onMoveRight="ctrl.handleMoveRight"\n    /><span>(</span>\n  '),u=r.ctrl,s=r.func,c=!1,l=0,f=null;function p(e){var t=d()(this),n=t.prev(".comma"),r=t.next();r.val(s.params[e]),n.removeClass("query-part__last"),t.hide(),r.show(),r.focus(),r.select();var a=r.data("typeahead");a&&(r.val(""),a.lookup())}function m(e){return e<s.def.params.length?s.def.params[e]:i.a.last(s.def.params).multiple?i.a.assign({},i.a.last(s.def.params),{optional:!0}):{}}function h(e,n){var a=d()(e);clearTimeout(f),f=null;var i=a.prev(),o=i.prev(".comma"),p=a.val();(""!==p||m(n).optional)&&(s.updateParam(p,n),i.html(p?t.highlightVariablesAsHtml(p):"&nbsp;")),l!==s.params.length&&(c||(c=!0,setTimeout((function(){x(),c=!1}),200))),r.$apply((function(){u.targetChanged()})),i.hasClass("query-part__last")&&""===p?o.addClass("query-part__last"):i.removeClass("query-part__last"),a.hide(),i.show()}function g(e){var t=this;f=setTimeout((function(){h(t,e)}),200)}function v(e,t){13===t.which&&d()(this).blur()}function y(){this.style.width=8*(3+this.value.length)+"px"}function b(){o.appendTo(a);for(var u=i.a.clone(s.def.params),c=i.a.last(s.def.params);s.params.length>=u.length&&c&&c.multiple;)u.push(i.a.assign({},c,{optional:!0}));i.a.each(u,(function(e,r){if(e.optional&&s.params.length<r)return!1;var o=t.highlightVariablesAsHtml(s.params[r]),u=null!=o,c=r>=s.params.length-1&&e.optional&&!u;c&&e.multiple&&(o="+"),r>0&&d()('<span class="comma'+(c?" query-part__last":"")+'">, </span>').appendTo(a);var f=d()('<a ng-click="" class="graphite-func-param-link'+(c?" query-part__last":"")+'">'+(u?o:"&nbsp;")+"</a>"),b=d()(n);return b.attr("placeholder",e.name),l++,f.appendTo(a),b.appendTo(a),b.blur(i.a.partial(g,r)),b.keyup(y),b.keypress(i.a.partial(v,r)),f.click(i.a.partial(p,r)),e.options&&function(e,t){e.attr("data-provide","typeahead");var n=m(t).options;"int"!==m(t).type&&"float"!==m(t).type||(n=i.a.map(n,(function(e){return e.toString()}))),e.typeahead({source:n,minLength:0,items:20,updater:function(n){return e.val(n),h(e[0],t),n}}),e.data("typeahead").lookup=function(){return this.query=this.$element.val()||"",this.process(this.source)}}(b,r),!0})),d()("<span>)</span>").appendTo(a),e(a.contents())(r)}function x(){a.children().remove(),b(),r.func.added&&(r.func.added=!1,setTimeout((function(){a.find(".graphite-func-param-link").first().click()}),10))}u.handleRemoveFunction=function(e){u.removeFunction(e)},u.handleMoveLeft=function(e){u.moveFunction(e,-1)},u.handleMoveRight=function(e){u.moveFunction(e,1)},x()}}}Zt.a.directive("zabbixFunctionEditor",nn),function(e,t,n){Zt.a.directive(e,["reactDirective",function(e){return e(t,n)}])}("zbxFunctionEditor",tn,["func","onRemove","onMoveLeft","onMoveRight"]),n.d(t,"QueryOptionsCtrl",(function(){return rn})),n.d(t,"AnnotationsQueryCtrl",(function(){return an})),n.d(t,"Datasource",(function(){return ft})),n.d(t,"ConfigCtrl",(function(){return It})),n.d(t,"QueryCtrl",(function(){return kt})),n.d(t,"VariableQueryEditor",(function(){return Qt}));var rn=function(){function e(){}return e.templateUrl="datasource-zabbix/partials/query.options.html",e}(),an=function(){function e(){}return e.templateUrl="datasource-zabbix/partials/annotations.editor.html",e}();kt.templateUrl="datasource-zabbix/partials/query.editor.html",It.templateUrl="datasource-zabbix/partials/config.html",Object(r.loadPluginCss)({dark:"plugins/alexanderzobnin-zabbix-app/css/grafana-zabbix.dark.css",light:"plugins/alexanderzobnin-zabbix-app/css/grafana-zabbix.light.css"})}])}));
//# sourceMappingURL=module.js.map